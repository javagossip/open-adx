# 广告引擎扩展点说明文档

本文档介绍了 OpenADX 广告引擎中提供的扩展点机制，这些扩展点通过 SPI（Service Provider Interface）模式提供，允许开发者根据业务需求实现自定义功能。

## 1. 扩展点概述

OpenADX 的扩展点基于 `com.chaincoretech.epc.annotation.ExtensionPoint` 注解实现，位于 [top.openadexchange.openapi.ssp.domain.gateway](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/domain/gateway/package-info.java) 包下。每个扩展点都是一个接口，可以通过 ExtensionRegistry 来获取具体的实现。

## 2. 扩展点详解

### 2.1 ExecutorFactory - 执行器工厂扩展点

**接口定义**: [top.openadexchange.openapi.ssp.domain.gateway.ExecutorFactory](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/domain/gateway/ExecutorFactory.java)

**功能描述**: 提供自定义线程池执行器的扩展点，用于处理广告引擎中的异步任务。

**方法说明**:
- `ExecutorService getExecutor()` - 获取自定义的执行器实例

**使用场景**: 当系统默认的线程池配置无法满足性能需求时，可通过实现此扩展点来自定义线程池配置。

**配置方式**: 通过 [OaxEngineProperties.executorFactory](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/config/OaxEngineProperties.java#L7-L25) 属性指定实现。

### 2.2 IP2RegionService - IP 地理位置服务扩展点

**接口定义**: [top.openadexchange.openapi.ssp.domain.gateway.IP2RegionService](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/domain/gateway/IP2RegionService.java)

**功能描述**: 提供 IP 地址到地理位置转换的服务扩展点。

**方法说明**:
- `IpLocation getRegion(String ip)` - 根据 IPv4 地址获取地理位置信息
- `IpLocation getRegionByIpV6(String ipv6)` - 根据 IPv6 地址获取地理位置信息

**使用场景**: 用于获取用户地理位置，支持地域定向投放广告。

**配置方式**: 通过 [OaxEngineProperties.ip2RegionService](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/config/OaxEngineProperties.java#L7-L25) 属性指定实现。

### 2.3 IndexService - 索引服务扩展点

**接口定义**: [top.openadexchange.openapi.ssp.domain.gateway.IndexService](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/domain/gateway/IndexService.java)

**功能描述**: 提供 DSP 数据索引和搜索服务的扩展点，用于快速检索符合条件的 DSP。

**方法说明**:
- `void indexDsp(DspAggregate dspAggregate)` - 索引 DSP 信息
- `void indexAdGroup(DspAggregate dspAggregate)` - 索引广告组信息
- `List<Integer> searchDsps(IndexKeys indexKeys)` - 根据索引键搜索 DSP 列表

**使用场景**: 用于构建和维护 DSP 检索索引，支持高效的 DSP 匹配。

**配置方式**: 通过 [OaxEngineProperties.indexService](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/config/OaxEngineProperties.java#L7-L25) 属性指定实现。

### 2.4 MetadataRepository - 元数据仓储扩展点

**接口定义**: [top.openadexchange.openapi.ssp.domain.gateway.MetadataRepository](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/domain/gateway/MetadataRepository.java)

**功能描述**: 提供广告元数据访问的扩展点，包括 DSP、广告位、站点等信息。

**方法说明**:
- `SiteAdPlacement getSiteAdPlacementByTagId(String tagId)` - 根据标签 ID 获取广告位信息
- `Site getSite(Long siteId)` - 根据站点 ID 获取站点信息
- `List<DspAggregate> getDspByIds(List<Integer> dspIds)` - 根据 ID 列表获取 DSP 信息
- `AdPlacement getAdPlacement(Integer id)` - 根据 ID 获取广告位信息
- `Dsp getDspByDspId(String dspId)` - 根据 DSP ID 获取 DSP 信息

**使用场景**: 用于访问广告引擎所需的元数据，支持数据库访问和缓存访问等多种实现方式。

**配置方式**: 通过 [OaxEngineProperties](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/config/OaxEngineProperties.java#L7-L25) 配置不同实现，系统内置 "db"（数据库）和 "cache"（缓存）两种实现。

### 2.5 MetadataCacheService - 元数据缓存服务扩展点

**接口定义**: [top.openadexchange.openapi.ssp.domain.gateway.MetadataCacheService](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/domain/gateway/MetadataCacheService.java)

**功能描述**: 提供广告元数据缓存操作的扩展点，用于缓存和管理元数据。

**方法说明**:
- `void addDsp(DspAggregate dspAggregate)` - 添加 DSP 到缓存
- `DspAggregate getDsp(Integer dspId)` - 从缓存获取 DSP 信息
- `Map<Integer,DspAggregate> getDsps(List<Integer> dspIds)` - 批量从缓存获取 DSP 信息
- `Site getSite(Long siteId)` - 从缓存获取站点信息
- `SiteAdPlacement getSiteAdPlacementByTagId(String tagId)` - 从缓存获取广告位信息
- `AdPlacement getAdPlacement(Integer id)` - 从缓存获取广告位配置
- `void addSite(Site site)` - 添加站点到缓存
- `void addSiteAdPlacement(SiteAdPlacement siteAdPlacement)` - 添加广告位到缓存
- `void addAdPlacement(AdPlacement adPlacement)` - 添加广告位配置到缓存
- `Dsp getDspByDspId(String dspId)` - 从缓存获取 DSP 信息

**使用场景**: 用于实现高效的元数据缓存机制，提升广告引擎性能。

### 2.6 OaxHttpClient - HTTP 客户端扩展点

**接口定义**: [top.openadexchange.openapi.ssp.domain.gateway.OaxHttpClient](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/domain/gateway/OaxHttpClient.java)

**功能描述**: 提供 HTTP 客户端的扩展点，用于发送 HTTP 请求到 DSP 或其他外部服务。

**方法说明**:
- `OaxHttpResponse post(String url, Duration timeout, byte[] body)` - 发送 POST 请求

**使用场景**: 用于广告引擎与 DSP 之间的通信，支持不同的 HTTP 客户端实现。

**配置方式**: 系统默认使用 "default" 实现。

## 3. 扩展点使用方式

### 3.1 扩展点初始化

系统通过 [OaxEngineServices](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/domain/gateway/OaxEngineServices.java) 类初始化各种扩展点实现：

```java
@PostConstruct
public void init() {
    indexService = ExtensionRegistry.getExtensionByKey(IndexService.class, oaxEngineProperties.getIndexService());
    ip2RegionService = ExtensionRegistry.getExtensionByKey(IP2RegionService.class, oaxEngineProperties.getIp2RegionService());
    dbMetadataRepository = ExtensionRegistry.getExtensionByKey(MetadataRepository.class, "db");
    cachedMetadataRepository = ExtensionRegistry.getExtensionByKey(MetadataRepository.class, "cache");
}
```

### 3.2 扩展点获取

通过 ExtensionRegistry 获取特定的扩展点实现：

```java
MyExtension impl = ExtensionRegistry.getExtensionByKey(MyExtension.class, "implementationKey");
```

## 4. 自定义扩展点实现步骤

1. 创建扩展点实现类，实现对应的扩展点接口
2. 在资源目录下创建 [META-INF/extensions](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/resources/META-INF/extensions) 目录
3. 在该目录下创建对应扩展点接口的配置文件
4. 在配置文件中声明实现类及其键值
5. 通过 [OaxEngineProperties](file:///Users/mac/Documents/workspaces/java/open-adx/open-adexchange-api/open-adexchange-ssp-api/src/main/java/top/openadexchange/openapi/ssp/config/OaxEngineProperties.java#L7-L25) 配置使用哪个实现

## 5. 注意事项

1. 所有扩展点实现必须保证线程安全
2. 扩展点实现应考虑性能影响，特别是频繁调用的方法
3. 扩展点实现应具备良好的容错能力
4. 扩展点实现应合理使用资源，避免内存泄漏
5. 扩展点实现应提供适当的日志记录以便调试