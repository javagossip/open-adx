# 价格加解密技术文档

## 概述

本文档描述了 Open Ad Exchange (OAX) 系统中获胜价格（Win Price）的加密和解密实现方案。该方案使用 HMAC-SHA1 和异或（XOR）运算来保护价格数据的机密性和完整性。

## 核心类

**类名**: `OaxWinPriceCodec`  
**包路径**: `top.openadexchange.openapi.ssp.domain.core`  
**实现接口**: `WinPriceCodec`  
**扩展点**: `@Extension(keys = {"default"})`

## 算法设计

### 加密流程（encode）

```
输入: price (long), dsp (Dsp)
输出: 加密后的价格字符串 (Base64 URL Safe)
```

#### 步骤说明

1. **密钥解码**
   - 从 DSP 配置中获取加密密钥（eKey）和集成密钥（iKey）
   - 使用 Base64 URL 解码器将密钥转换为字节数组

2. **生成随机 IV（初始化向量）**
   - 生成 16 字节的随机 IV（Initialization Vector）
   - 使用 `SecureRandom` 确保随机性

3. **计算 HMAC-SHA1 Pad**
   - 使用加密密钥（eKey）和 IV 生成 HMAC-SHA1 哈希
   - 取哈希值的前 8 字节作为 XOR 运算的 Pad

4. **价格加密（异或运算）**
   - 将价格（long 类型）转换为 8 字节数组
   - 使用 Pad 对价格进行异或（XOR）运算
   - 异或运算是可逆的，解密时使用相同的 Pad 即可还原

5. **计算签名（完整性保护）**
   - 使用集成密钥（iKey）生成 HMAC-SHA1 哈希
   - 输入为：价格字节数组 + IV
   - 取签名的前 4 字节作为最终签名

6. **拼接和编码**
   - 拼接数据结构：IV (16 bytes) + 加密价格 (8 bytes) + 签名 (4 bytes) = 28 bytes
   - 使用 Base64 URL Safe 编码（无填充）输出

### 解密流程（decode）

```
输入: encryptedPrice (String), dsp (Dsp)
输出: 原始价格 (long)
```

#### 步骤说明

1. **密钥解码**
   - 使用 Guava 的 `BaseEncoding.base64Url()` 解码密钥
   - 确保与加密时使用相同的密钥

2. **Base64 解码**
   - 解码加密后的价格字符串
   - 验证解码后的数据长度必须为 28 字节（16 + 8 + 4）

3. **拆解字节流**
   - 从 ByteBuffer 中提取：
     - IV: 16 字节
     - 加密价格: 8 字节
     - 签名: 4 字节

4. **还原价格（异或运算）**
   - 使用加密密钥（eKey）和 IV 重新生成 Pad
   - 对加密价格进行异或运算，还原原始价格字节数组
   - 将字节数组转换为 long 类型

5. **完整性校验**
   - 使用集成密钥（iKey）重新计算签名
   - 输入为：还原后的价格字节数组 + IV
   - 取签名的前 4 字节
   - 与存储的签名进行比较
   - 如果不匹配，抛出 `SecurityException`

## 数据结构

### 加密数据结构

```
+------------------+------------------+------------------+
|      IV          |  Encrypted Price |      Signature   |
|  (16 bytes)      |    (8 bytes)     |    (4 bytes)     |
+------------------+------------------+------------------+
|     随机向量      |   价格 XOR Pad   |  HMAC-SHA1 前4B  |
+------------------+------------------+------------------+
```

### 编码格式

- **编码方式**: Base64 URL Safe（无填充）
- **总长度**: 28 字节 → 37 字符（Base64 编码后）
- **编码字符集**: A-Z, a-z, 0-9, -, _（无 +, / 和 =）

## 常量定义

| 常量名 | 值 | 说明 |
|--------|-----|------|
| `IV_SIZE` | 16 | IV（初始化向量）大小（字节） |
| `PRICE_SIZE` | 8 | 价格大小（字节，long 类型） |
| `SIG_SIZE` | 4 | 签名大小（字节，HMAC-SHA1 前 4 字节） |

## 依赖库

| 库 | 用途 |
|----|------|
| `com.google.common.hash.Hashing` | HMAC-SHA1 哈希计算 |
| `com.google.common.io.BaseEncoding` | Base64 URL Safe 编解码 |
| `com.google.common.primitives.Longs` | long 类型与字节数组转换 |
| `java.security.SecureRandom` | 生成安全的随机 IV |

## 安全特性

### 1. 机密性（Confidentiality）
- 使用 HMAC-SHA1 生成的 Pad 对价格进行加密
- 每次加密使用不同的随机 IV，防止模式分析攻击
- 只有持有加密密钥（eKey）的方才能解密价格

### 2. 完整性（Integrity）
- 使用 HMAC-SHA1 签名验证数据未被篡改
- 签名计算包含价格和 IV，确保数据完整性
- 解密时会验证签名，失败则抛出异常

### 3. 防重放攻击（Replay Attack Protection）
- 每次加密使用随机 IV，即使相同价格，加密结果也不同
- 接收方无法通过重放之前的加密数据来欺骗系统

### 4. 密钥分离（Key Separation）
- 加密密钥（eKey）用于价格加密
- 集成密钥（iKey）用于完整性验证
- 两个密钥独立管理，提高安全性

## 使用示例

### 加密示例

```java
import top.openadexchange.openapi.ssp.domain.core.OaxWinPriceCodec;
import top.openadexchange.model.Dsp;

// 创建编解码器
OaxWinPriceCodec codec = new OaxWinPriceCodec();

// 创建 DSP 对象（配置密钥）
Dsp dsp = new Dsp();
dsp.setEncryptionKey("dGVzdEVuY3J5cHRpb25LZXk="); // Base64 编码的加密密钥
dsp.setIntegrationKey("dGVzdEludGVncmF0aW9uS2V5"); // Base64 编码的集成密钥

// 加密价格
long price = 1234567890L;
String encryptedPrice = codec.encode(price, dsp);

// 输出结果（类似：7f8a9b2c...）
System.out.println("加密后的价格: " + encryptedPrice);
```

### 解密示例

```java
import top.openadexchange.openapi.ssp.domain.core.OaxWinPriceCodec;
import top.openadexchange.model.Dsp;

// 创建编解码器
OaxWinPriceCodec codec = new OaxWinPriceCodec();

// 创建 DSP 对象（配置密钥）
Dsp dsp = new Dsp();
dsp.setEncryptionKey("dGVzdEVuY3J5cHRpb25LZXk=");
dsp.setIntegrationKey("dGVzdEludGVncmF0aW9uS2V5");

// 解密价格
String encryptedPrice = "7f8a9b2c...";
long decodedPrice = codec.decode(encryptedPrice, dsp);

// 输出结果
System.out.println("解密后的价格: " + decodedPrice);
```

## 异常处理

### 编码异常

| 异常类型 | 触发条件 | 处理建议 |
|----------|----------|----------|
| `IllegalArgumentException` | 密钥格式不正确 | 检查 DSP 配置中的密钥是否为有效的 Base64 字符串 |
| `IllegalArgumentException` | 密钥长度不足 | 确保密钥长度满足 HMAC-SHA1 的要求 |

### 解码异常

| 异常类型 | 触发条件 | 处理建议 |
|----------|----------|----------|
| `IllegalArgumentException` | 加密数据长度无效 | 验证加密后的字符串是否完整 |
| `SecurityException` | 完整性校验失败 | 数据可能被篡改，拒绝接受该价格 |
| `IllegalArgumentException` | 密钥格式不正确 | 检查 DSP 配置中的密钥是否为有效的 Base64 字符串 |

## 性能特点

| 指标 | 说明 |
|------|------|
| 加密耗时 | 约 0.1-0.5 毫秒（单次） |
| 解密耗时 | 约 0.1-0.5 毫秒（单次） |
| 内存占用 | 每次操作约 100-200 字节 |
| 线程安全 | 是（Guava 的 `Hashing.hmacSha1` 是线程安全的） |

## 密钥管理建议

1. **密钥生成**
   - 使用安全的随机数生成器生成密钥
   - 密钥长度建议不少于 16 字节（128 位）

2. **密钥存储**
   - 使用安全的密钥管理系统（KMS）存储密钥
   - 避免在代码或配置文件中硬编码密钥
   - 定期轮换密钥

3. **密钥分发**
   - 通过安全的渠道（如 TLS）传输密钥
   - 确保 DSP 和 SSP 双方拥有相同的密钥对

4. **密钥分离**
   - 加密密钥和集成密钥应该不同
   - 建议使用独立的密钥管理系统分别管理

## 注意事项

1. **Base64 编码差异**
   - `encode` 方法使用 `java.util.Base64.getUrlDecoder()`
   - `decode` 方法使用 Guava 的 `BaseEncoding.base64Url()`
   - 两者在功能上等效，但建议保持一致性

2. **签名截断**
   - 只使用 HMAC-SHA1 签名的前 4 字节
   - 虽然降低了安全性，但减少了数据传输量
   - 在实际应用中可以增加签名长度以提高安全性

3. **价格精度**
   - 价格使用 long 类型存储，注意精度丢失问题
   - 建议以"分"为单位存储价格（整数），避免浮点数精度问题

4. **线程安全**
   - 编解码器实例可以安全地在多线程环境中使用
   - 不需要为每个线程创建新的实例

5. **密钥更新**
   - 密钥更新后，需要确保新旧密钥都能正常工作
   - 建议实施密钥版本管理机制

## 扩展点

`OaxWinPriceCodec` 实现了 `WinPriceCodec` 接口，并使用 `@Extension(keys = {"default"})` 注解标记为默认实现。

可以通过以下方式扩展或替换实现：

```java
@Extension(keys = {"custom"})
public class CustomWinPriceCodec implements WinPriceCodec {
    @Override
    public String encode(long price, Dsp dsp) {
        // 自定义加密逻辑
    }

    @Override
    public long decode(String encryptedPrice, Dsp dsp) {
        // 自定义解密逻辑
    }
}
```

## 参考资料

- [RFC 2104 - HMAC: Keyed-Hashing for Message Authentication](https://tools.ietf.org/html/rfc2104)
- [RFC 4648 - The Base16, Base32, and Base64 Data Encodings](https://tools.ietf.org/html/rfc4648)
- [Guava - Hashing](https://guava.dev/releases/snapshot-jre/api/docs/com/google/common/hash/Hashing.html)
- [Guava - BaseEncoding](https://guava.dev/releases/snapshot-jre/api/docs/com/google/common/io/BaseEncoding.html)

## 更新日志

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2026-01-08 | 初始版本，实现基础的价格加解密功能 |

## 联系方式

如有问题或建议，请联系开发团队。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-08  
**维护者**: Open Ad Exchange Team
